rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 사용자 컬렉션
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // 차단 사용자 서브컬렉션
      match /blocked_users/{blockId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 신고 컬렉션
    match /reports/{reportId} {
      allow create: if request.auth != null && request.resource.data.reporterId == request.auth.uid;
      allow read: if false; // 관리자만 볼 수 있도록 기본값 차단 (Firebase Console에서 확인)
    }

    // 청소 요청 컬렉션
    match /cleaning_requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      
      // 업데이트 허용 조건:
      // 1. 작성자 본인
      // 2. 이미 수락된 담당자 (진행상황 업데이트 등)
      // 3. 의뢰를 수락하려는 사람 (본인을 acceptedApplicantId로 설정)
      // 4. 의뢰에 지원하려는 사람 (본인을 applicants에 포함)
      // 5. 지원을 취소하려는 사람 (본인이 applicants에 있었던 경우 - 중요!)
      // 6. 직접 지정된 전문가 (targetStaffId가 본인인 경우)
      allow update: if request.auth != null && (
        resource.data.authorId == request.auth.uid || 
        resource.data.acceptedApplicantId == request.auth.uid ||
        request.resource.data.acceptedApplicantId == request.auth.uid ||
        request.auth.uid in request.resource.data.applicants ||
        request.auth.uid in resource.data.applicants || 
        resource.data.targetStaffId == request.auth.uid
      );
      
      allow delete: if request.auth != null && resource.data.authorId == request.auth.uid;
      
      // 신청자 서브컬렉션 (사용하지 않는 경우도 있지만 유지)
      match /applicants/{applicantId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }
    
    // 청소 전문가 컬렉션 ('cleaning_staffs'가 정확한 이름입니다)
    match /cleaning_staffs/{staffId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && 
        resource.data.authorId == request.auth.uid;
    }
    
    // 완료 보고서 컬렉션
    match /completion_reports/{reportId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // 채팅방 컬렉션
    match /chat_rooms/{roomId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
      
      allow update: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      allow delete: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // 청소 노하우
    match /cleaning_knowhows/{knowhowId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
    
    // 청소 추천
    match /cleaning_recommendations/{recommendationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
    
    // 기타 컬렉션 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
